package pt.test;

import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.concurrent.ConcurrentLinkedQueue;

public class TestMultiTask {
	private static final int N_DATASIZE = 0;

	private static final String BM_METHOD = "execute";
	
	private static final Class<?>[] BM_METHOD_ARGUEMENT_TYPE = {int.class};

	private static final String MOL = "MOL";

	private static final String MOL_CLASS = "core.moldyn.Molcore";

	private static final String MON = "MON";

	private static final String MON_CLASS = "core.montecarlo.Moncore";

	private static final String RAY = "RAY";

	private static final String RAY_CLASS = "core.raytracer.Raycore";
	
	private static ConcurrentLinkedQueue<Benchmark> concurrentLinkedQueue = null;

	public static void main(String[] args) {
		if (null == args || args.length != 2) {
			try {
				throw new Exception("Wrong arguemnts setting");
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
		
		
		
		TaskID tid_0 = runBMS_0(createBenchmarkSet(getBenchmarkClass(args[0]), Integer.valueOf(args[1])));
		TaskID tid_1 = runBMS_1(createBenchmarkSet(getBenchmarkClass(args[0]), Integer.valueOf(args[1])));
		TaskID tid_2 = runBMS_2(createBenchmarkSet(getBenchmarkClass(args[0]), Integer.valueOf(args[1])));
		TaskID tid_3 = runBMS_3(createBenchmarkSet(getBenchmarkClass(args[0]), Integer.valueOf(args[1])));
		TaskID tid_4 = runBMS_4(createBenchmarkSet(getBenchmarkClass(args[0]), Integer.valueOf(args[1])));
		
		TaskIDGroup tig = new TaskIDGroup(5);
		
		tig.add(tid_0);
		tig.add(tid_1);
		tig.add(tid_2);
		tig.add(tid_3);
		tig.add(tid_4);
		
		try {
			tig.waitTillFinished();
		} catch (ExecutionException e) {
			e.printStackTrace();
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
	}
	TASK(8) private static void runBMS_0(ConcurrentLinkedQueue<Benchmark> benchmarkQueue) {		
		System.out.println("Multi Task 0 [thread "+CurrentTask.currentThreadID()+"] [thread LocalID "+CurrentTask.currentThreadLocalID()+"] [globalID "+CurrentTask.globalID()+"]  [subtask "+CurrentTask.relativeID()+"]  [mulTaskSize "+CurrentTask.multiTaskSize()+"] ");
		Benchmark benchmark = null; 
		while (null != (benchmark = benchmarkQueue.poll())) { 
			runBM(benchmark); 
		} 
	}
	
	TASK(8) private static void runBMS_1(ConcurrentLinkedQueue<Benchmark> benchmarkQueue) {		
		System.out.println("Multi Task 1 [thread "+CurrentTask.currentThreadID()+"] [thread LocalID "+CurrentTask.currentThreadLocalID()+"] [globalID "+CurrentTask.globalID()+"]  [subtask "+CurrentTask.relativeID()+"]  [mulTaskSize "+CurrentTask.multiTaskSize()+"] ");
		Benchmark benchmark = null; 
		while (null != (benchmark = benchmarkQueue.poll())) { 
			runBM(benchmark); 
		} 
	}
	
	TASK(8) private static void runBMS_2(ConcurrentLinkedQueue<Benchmark> benchmarkQueue) {		
		System.out.println("Multi Task 2 [thread "+CurrentTask.currentThreadID()+"] [thread LocalID "+CurrentTask.currentThreadLocalID()+"] [globalID "+CurrentTask.globalID()+"]  [subtask "+CurrentTask.relativeID()+"]  [mulTaskSize "+CurrentTask.multiTaskSize()+"] ");
		Benchmark benchmark = null; 
		while (null != (benchmark = benchmarkQueue.poll())) { 
			runBM(benchmark); 
		} 
	}
	
	TASK(8) private static void runBMS_3(ConcurrentLinkedQueue<Benchmark> benchmarkQueue) {	
		System.out.println("Multi Task 3 [thread "+CurrentTask.currentThreadID()+"] [thread LocalID "+CurrentTask.currentThreadLocalID()+"] [globalID "+CurrentTask.globalID()+"]  [subtask "+CurrentTask.relativeID()+"]  [mulTaskSize "+CurrentTask.multiTaskSize()+"] ");
		Benchmark benchmark = null; 
		while (null != (benchmark = benchmarkQueue.poll())) { 
			runBM(benchmark);
		} 
	}
	
	TASK(8) private static void runBMS_4(ConcurrentLinkedQueue<Benchmark> benchmarkQueue) {		
		System.out.println("Multi Task 4 [thread "+CurrentTask.currentThreadID()+"] [thread LocalID "+CurrentTask.currentThreadLocalID()+"] [globalID "+CurrentTask.globalID()+"]  [subtask "+CurrentTask.relativeID()+"]  [mulTaskSize "+CurrentTask.multiTaskSize()+"] ");
		Benchmark benchmark = null; 
		while (null != (benchmark = benchmarkQueue.poll())) { 
			runBM(benchmark); 
		} 
	}


	private static void runBM(Benchmark benchmark) {
		try {
			benchmark.getMethod().invoke(benchmark.getInstance(), benchmark.getArguments());
		} catch (IllegalAccessException e) {
			e.printStackTrace();
		} catch (IllegalArgumentException e) {
			e.printStackTrace();
		} catch (InvocationTargetException e) {
			e.printStackTrace();
		}
	}

	private static ConcurrentLinkedQueue<Benchmark> createBenchmarkSet(Class<?> bmClass, Integer setLen) {
		concurrentLinkedQueue = new ConcurrentLinkedQueue<Benchmark>();
		for (int i = 0; i < setLen; i++) {
			Object benchmark = null;
			Method method = null;
			try {
				benchmark = bmClass.newInstance();
				method = bmClass.getMethod(BM_METHOD, BM_METHOD_ARGUEMENT_TYPE);
			} catch (InstantiationException e) {
				e.printStackTrace();
			} catch (IllegalAccessException e) {
				e.printStackTrace();
			} catch (NoSuchMethodException e) {
				e.printStackTrace();
			} catch (SecurityException e) {
				e.printStackTrace();
			} catch (IllegalArgumentException e) {
				e.printStackTrace();
			}
			Object[] arguments = new Object[1];
			arguments[0] = N_DATASIZE;

			concurrentLinkedQueue.add(new Benchmark(benchmark, method, arguments));

		}
		return concurrentLinkedQueue;
	}

	private static Class<?> getBenchmarkClass(String bmName) {

		Class<?> bmClass = null;

		try {
			if (bmName.equalsIgnoreCase(MOL)) {
				bmClass = Class.forName(MOL_CLASS);
			} else if (bmName.equalsIgnoreCase(MON)) {
				bmClass = Class.forName(MON_CLASS);
			} else if (bmName.equalsIgnoreCase(RAY)) {
				bmClass = Class.forName(RAY_CLASS);
			} else {
				throw new Exception("Can not find the Benchmark " + bmName);
			}
		} catch (ClassNotFoundException e) {
			e.printStackTrace();
		} catch (Exception e) {
			e.printStackTrace();
		}

		return bmClass;
	}
}
